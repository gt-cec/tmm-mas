<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication Box</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/robotButton.js') }}"></script>
    <script src="{{ url_for('static', filename='js/drawing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sockets.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="left-section">
        <div class="title">Simulation Visualization</div>
        <div class="map-container">
            <canvas id="simulationCanvas" width="700" height="700"></canvas>
        </div>
    </div>

    <div class="right-section">
        <div class="title">Communication Box</div>
        <div class="communication-container">
            <div id="robot-buttons-container" class="robot-buttons-container"></div>
            <button id="playStopButton">Play</button>
            <div id="data">
                <div id="statusMessage" class="blinking-text">Communication framework running</div>
            </div>
            <div class="slider-container">
                <label for="disparitySlider">MM Disparity:</label>
                <input type="range" id="disparitySlider" min="0" max="2" step="1" value="0">
                <div class="slider-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                </div>
            </div>
            
            <div class="input-box">
                <input class="input-box-text" type="text" placeholder="Send a message...">
                <button class="input-box-button" type="submit">Submit</button>
            </div>
        </div>
    </div>

    <script>
        const dataDiv = document.getElementById('data')
        const statusMessage = document.getElementById('statusMessage')
        const playStopButton = document.getElementById('playStopButton')
        const disparitySlider = document.getElementById('disparitySlider')
        const canvas = document.getElementById('simulationCanvas')
        const ctx = canvas.getContext('2d')
        const canvasMapImage = new Image()
        loadCanvasMapImage()
        const gridSize = 10
        const cellSize = canvas.width / gridSize

        var robotFilterId = -1  // which robot ID to filter

        let socket = createSocket()
        let isPlaying = false
        let robotPath = []

        var numRobots = -1  // number of robots in the simulation
        var savedRobotData = {}  // last copy of all the robot data, for re-draws

        function displayMessage(message, dynamicThreshold) {
            const messageBox = document.createElement('div')
            messageBox.classList.add('message-box')

            switch (dynamicThreshold) {
                case 'low':
                    messageBox.classList.add('message-low')
                    break
                case 'medium':
                    messageBox.classList.add('message-medium')
                    break
                case 'high':
                    messageBox.classList.add('message-high')
                    break
            }

            messageBox.innerText = message
            messageBox.robotId = 1  // !! REPLACE THIS WITH THE ROBOT ID THAT GENERATED THE MESSAGE!!!
            // if the robot ID is currently filtered out, set display to none
            if (!isRobotIdVisible(messageBox.robotId)) {
                messageBox.style.display = "none"
            }
            dataDiv.prepend(messageBox) // Prepend for latest messages at the top
        }

        playStopButton.addEventListener("click", () => {
            isPlaying = !isPlaying
            if (isPlaying) {
                playStopButton.textContent = 'Stop'
            }
            else {
                playStopButton.textContent = 'Play'
            }
            socket.send(isPlaying)
        })

        // Initial draw
        drawGrid()
    </script>
</body>

</html>
